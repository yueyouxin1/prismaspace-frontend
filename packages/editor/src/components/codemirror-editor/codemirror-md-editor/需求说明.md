# CodeMirrorMdEditor 表达式能力迭代需求说明（Vue 3）

> 用途：在 `@repo/editor` 中落地 `CodeMirrorMdEditor` 组件，提供 Markdown 编辑场景下的表达式输入、替换渲染与高亮渲染能力。  
> 适用：`packages/editor/src/components/codemirror-editor/codemirror-md-editor/*`

---

## 0. 文档信息

- 需求名称：`CodeMirrorMdEditor 表达式能力迭代`
- 需求编号：`N/A`
- 提出人：`N/A`
- 负责人：`N/A`
- 计划版本：`最近可交付迭代`
- 预计开发周期：`待排期`
- 关联链接：`doc/创建子包需求说明模板.md`

---

## 1. 项目约束文档（强制遵循）

以下文档是实现与验收的上位约束，冲突时优先按这些文档执行：

- `README.md`（仓库根目录）：项目级工程约定、脚本与协作说明
- `doc/ui-development-guidelines.md`：UI 组件选型、兜底路径与参考实现要求
- `doc/Vue通用架构与开发规范指南.md`：Vue 工程结构与编码规范

---

## 2. 需求背景与目标

### 2.1 背景

当前项目已有 `MdEditor`（Monaco 方案），但目标是新增基于 CodeMirror 的 Markdown 编辑器组件 `CodeMirrorMdEditor`，并补齐表达式能力，保证编辑体验与原始 Markdown 文本存储格式解耦。

### 2.2 目标

- 目标 1：在编辑器输入指定表达式前缀时弹出变量选择面板，并支持插入/替换表达式文本
- 目标 2：通过规则配置实现表达式 `replace`（UI 替换）与 `highlight`（背景高亮）两类渲染
- 目标 3：支持多表达式并行配置，不同表达式可采用不同处理策略，且行为稳定
- 目标 4：全程保持 Model 存储原始 Markdown 文本，不因 UI 渲染改变持久化内容

### 2.3 非目标（明确不做）

- Markdown AST 解析
- HTML 导出
- 服务端渲染
- Monaco 兼容方案

---

## 3. 子包定位与分层归属

### 3.1 包基础信息

- 子包目录：`packages/editor`
- 包名：`@repo/editor`
- 包类型：`UI 组件包内增量组件`
- 目标消费方：`apps/studio-web` 与其他 `@repo/*` 包

### 3.2 分层归属说明

- 归属层：`common`
- 归属理由：编辑器组件为跨应用复用能力，且不依赖业务域模型

### 3.3 依赖边界（必须填写）

- 允许依赖：`vue`、CodeMirror（v5 或 v6，择一）、`@repo/ui-shadcn`（用于面板 UI）
- 禁止依赖：`apps/*` 业务代码、`reference_example/*` 示例代码
- 是否涉及 UI 分层链路：`是`
- 若涉及 UI 分层，是否满足方向：`ui-ai-elements -> ui-shadcn -> ui-reka`：`是`

### 3.4 导入方式约束

- 应用层使用方式：仅通过 `@repo/editor` 导入
- 禁止事项：禁止跨包相对路径直连源码内部实现
- 对外暴露入口：`packages/editor/src/components/codemirror-editor/codemirror-md-editor/index.ts`

---

## 4. 需求范围

### 4.1 In Scope（本次范围）

1. Phase 1：表达式触发变量选择面板（输入触发、过滤、插入/替换、关闭行为）
2. Phase 2-1：表达式 `replace` 渲染（块级/行内）
3. Phase 2-2：表达式 `highlight` 渲染（背景高亮）
4. 多规则并存与优先级策略
5. 生命周期与编辑器状态同步（输入、光标、滚动、销毁）

### 4.2 Out of Scope（不在本次范围）

1. Markdown AST 语义解析与结构化编辑
2. SSR 与导出能力
3. Monaco 适配或双栈一致性方案

---

## 5. 详细需求清单（按优先级）

| 编号 | 优先级 | 需求描述 | 输入/触发 | 期望输出/行为 | 验收标准 |
|---|---|---|---|---|---|
| R-01 | P0 | Model 始终保存原始 Markdown 文本 | 任意编辑行为 | UI 替换/高亮仅影响编辑态展示 | 抽检表达式编辑前后，序列化文本与预期一致 |
| R-02 | P0 | 输入触发表达式前缀时弹出变量面板 | 输入 `{{` 或扩展前缀 | 光标附近显示面板，支持关键字过滤 | 光标移动/Esc/失焦后面板关闭且不残留 |
| R-03 | P0 | 变量选择后插入或替换表达式 | 在面板选择变量项 | 完成文本变更，光标移动到插入末尾，面板关闭 | 连续选择与撤销/重做行为正确 |
| R-04 | P0 | `replace` 规则渲染 | 文本匹配 `mode=replace` 规则 | 原文本编辑态显示为组件原子块 | 无法在表达式内部普通输入，支持 update/remove |
| R-05 | P0 | `highlight` 规则渲染 | 文本匹配 `mode=highlight` 规则 | 表达式增加背景高亮，不新增额外语义节点 | 光标、选区、复制、删除行为不受阻断 |
| R-06 | P1 | 多规则并存优先级 | 多规则命中同一区间 | `replace` 高于 `highlight`，同区间仅一个 replace 生效 | 构造冲突文本时命中与渲染结果稳定 |
| R-07 | P1 | 生命周期清理完整 | 输入/滚动/销毁 | 匹配与渲染状态实时同步，销毁时清理 marker/widget | 无内存泄漏、无残留 DOM/事件 |
| R-08 | P2 | 只读模式稳定渲染 | `readonly=true` | 可显示 replace/highlight，不允许非法编辑入口 | 只读场景交互无报错 |

---

## 6. UI 与交互约束（UI 相关子包必填）

### 6.1 组件选型顺序（强制）

1. 优先 `@repo/ui-shadcn`（变量面板与通用交互容器）
2. 智能场景优先 `@repo/ui-ai-elements`（若存在直接可复用实现）
3. 无覆盖时按顺序评估：`@repo/ui-reka` -> `tailwindcss` -> 原生 CSS

### 6.2 风格一致性要求

- 变量面板在视觉上需与现有 Playground / Studio 风格保持一致
- 替换组件需明确提供编辑入口（例如 Rename / Remove）
- 块级表达式的行高、间距、光标定位反馈必须稳定可预期

### 6.3 交互状态覆盖

- 默认态、Hover、Focus、Active、Disabled
- Loading、Empty、Error（主要针对变量面板）
- 只读态（替换块可展示不可编辑）

---

## 7. 技术方案与工程改动

### 7.1 目录与文件规划

```txt
packages/editor/src/components/codemirror-editor/codemirror-md-editor/
├── CodeMirrorMdEditor.vue
├── index.ts
├── types.ts
├── composables/
│   ├── use-expression-rules.ts
│   ├── use-expression-popup.ts
│   └── use-expression-rendering.ts
└── README.md
```

### 7.2 package.json 关键项

- 所属包：`packages/editor/package.json`
- `name`：`@repo/editor`
- `type`：`module`
- `exports`：通过 `packages/common/src/index.ts` 汇总导出 `codemirror-md-editor`

### 7.3 配置变更（按需）

若新增导出或路径，需同步检查：

- `packages/common/src/index.ts`
- `packages/common/src/plugin.ts`
- 根级 `tsconfig*.json` 的路径映射（若需要）

### 7.4 API 与类型设计

- 核心规则类型：

```ts
export interface MdExpressionRule {
  key: string
  match: RegExp
  mode: 'replace' | 'highlight'
  block?: boolean
  component?: Component
  componentProps?: (ctx: ExpressionContext) => Record<string, any>
  highlightClass?: string
}

export interface ExpressionContext {
  raw: string
  range: {
    from: CodeMirror.Position
    to: CodeMirror.Position
  }
}
```

- 替换组件事件约定：

```ts
interface ReplaceComponentEmits {
  (e: 'update', payload: { newText: string }): void
  (e: 'remove'): void
}
```

---

## 8. Demo 交付方案（强制）

### 8.1 Demo 实现位置

- 目录：`apps/studio-web/src/components/demo-playground/expression-md-editor/codemirror-expression-md-editor/`
- 主入口组件：`CodeMirrorMdEditorDemo.vue`（若沿用现有 Demo，可在现有文件新增切换展示）

### 8.2 Demo 注册

在 `apps/studio-web/src/data/component-demos.ts` 增加或更新：

- `slug`
- `title`
- `description`
- `tags`
- `component`

### 8.3 Demo 验证点

- 触发面板、筛选变量、插入替换完整链路
- `replace` 与 `highlight` 混合规则命中
- 块级 replace 的光标、排版与删除行为

---

## 9. 测试与验证

### 9.1 必跑命令

```bash
pnpm check:aliases
pnpm build
```

### 9.2 建议验证

```bash
pnpm dev
```

- 在 `/components` 可见 Demo 入口
- 在 `/components/:slug` 可进行交互验证

### 9.3 测试清单

- 单元测试：规则匹配、优先级冲突处理、插入替换逻辑
- 集成测试：面板显示关闭时机、replace/highlight 渲染与编辑联动
- 手工测试：100+ 表达式场景下输入/滚动性能，光标稳定性

---

## 10. 交付物清单（DoD 输入）

- `CodeMirrorMdEditor` 组件实现
- 表达式规则系统（多规则并行）
- 变量选择面板（Phase 1）
- replace/highlight 示例规则与示例组件
- 组件 README 与 Playground Demo

---

## 11. 风险、依赖与回滚

### 11.1 风险清单

| 风险 | 影响 | 概率 | 应对策略 |
|---|---|---|---|
| 匹配规则过多导致编辑卡顿 | 高 | 中 | 增量扫描与变更区间重算，避免全量重绘 |
| replace 与光标行为冲突 | 高 | 中 | 将 replace 节点视为原子单元，统一键盘与选区策略 |
| 滚动时 widget 定位偏移 | 中 | 中 | 绑定编辑器布局更新钩子，滚动时同步刷新 |

### 11.2 外部依赖

- CodeMirror（v5 或 v6，二选一）
- Vue 3 运行时渲染能力

### 11.3 回滚策略

- 保留 `MdEditor` 作为可切换回退路径
- 通过 feature flag 或组件开关逐步灰度接入 `CodeMirrorMdEditor`

---

## 12. 里程碑计划

| 里程碑 | 产出 | 负责人 | 截止日期 |
|---|---|---|---|
| M1 需求冻结 | 需求评审通过，规则模型冻结 | `待定` | `待定` |
| M2 Phase 1 完成 | 面板触发/插入替换可运行 | `待定` | `待定` |
| M3 Phase 2 完成 | replace/highlight 与优先级完成 | `待定` | `待定` |
| M4 验收上线 | Demo、文档、测试清单完成 | `待定` | `待定` |

---

## 13. 最终验收清单（DoD）

- [ ] 编辑器 Model 始终保存原始 Markdown 文本
- [ ] 表达式能力完全配置驱动，无硬编码规则
- [ ] 单一表达式实例任意时刻仅处于一种渲染模式
- [ ] 变量面板触发、关闭、插入替换行为稳定
- [ ] replace/highlight 并存策略符合优先级约束
- [ ] 100+ 表达式场景无明显卡顿
- [ ] 只读模式可稳定渲染
- [ ] `pnpm check:aliases` 通过
- [ ] `pnpm build` 通过

---

## 14. PR 自检清单

- [ ] 变更仅覆盖 `CodeMirrorMdEditor` 迭代范围
- [ ] 导出入口与导入边界符合仓库规范
- [ ] 核心交互场景附带可复现验证步骤
- [ ] 风险项与降级方案已在 PR 描述中说明
- [ ] 文档与 Demo 已同步更新

---

## 15. 附录（可选）

### 15.1 示例规则（非实现）

```ts
const rules: MdExpressionRule[] = [
  {
    key: 'var-expression',
    match: /\{\{[^}]+\}\}/g,
    mode: 'highlight',
    highlightClass: 'cm-var-highlight',
  },
  {
    key: 'library-block',
    match: /\{#LibraryBlock[\s\S]*?\{#\/LibraryBlock#\}/g,
    mode: 'replace',
    block: true,
    component: LibraryBlockView,
  },
]
```

### 15.2 结束说明

本需求文档仅约束行为与能力边界，不限制 CodeMirror 版本与具体 API 选型；实现细节由开发者结合项目实际决定。


